<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CTOUT Dashboard ‚Äì Draft Smartlink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="/public/css/dashboard.css"/>

</head>
<body>
<div id="app" class="d-flex layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div>
            <h5 class="fw-bold ps-2">CTOUT</h5>
            <div class="section-title">Main</div>
            <a href="#" class="nav-link"><i class="bi bi-grid"></i> Summary</a>
            <a href="/plan" class="nav-link"><i class="bi bi-currency-dollar"></i> Plan</a>

            <div class="section-title">Smartlinks</div>
            <div id="links-container">
                <a
                        v-for="link in links"
                        :key="link.id"
                        href="#"
                        class="nav-link"
                        :class="{ 'active-link': selectedLinkId === link.id }"
                        @click.prevent="selectLink(link.id)"
                >
                    <div class="d-flex align-items-center gap-2">
                        <div class="link-icon"
                             style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; overflow: hidden; background: #f8f9fa;">
                            <img v-if="link.logoFileName" :src="link.logoFileName" :alt="link.title"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                            <i v-else class="bi bi-link" style="font-size: 16px; color: #6c757d;"></i>
                        </div>
                        <div class="link-info">
                            <div class="link-title">{{ link.title }}</div>
                            <div class="link-description" style="font-size: 12px; color: #6c757d;">
                                {{ link.description || '' }}
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            <a href="#" class="btn btn-outline w-100 mt-2" @click.prevent="createNewLink">+ Create New</a>
        </div>
        <div>
            <div class="user-card mb-2">üí° Starter</div>
            <a href="/account" class="d-flex align-items-center gap-2 px-3 py-2 rounded-pill text-decoration-none"
               style="background: #f8fafd; border: 1px solid #dbe1ea;">
                <img th:src="${loggedInUser.picture}" alt="User" referrerpolicy="no-referrer" class="rounded-circle"
                     style="width: 32px; height: 32px; object-fit: cover;">
                <span class="fw-bold text-dark" th:text="${loggedInUser.name+' '+loggedInUser.surname}"></span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <div class="config-card">
            <div class="position-relative">
                <h4 class="fw-bold mb-3"><i class="bi bi-link-45deg"></i> Draft Smartlink</h4>
                <!-- Delete button (only show if a Smartlink is selected) -->
                <button
                        v-if="selectedLinkId"
                        class="delete-smartlink-btn"
                        @click="showDeleteConfirmation = true"
                        :disabled="isDeleting">
                    <i class="bi bi-trash"></i>
                    Delete Smartlink
                </button>
            </div>
            <!-- Section d√ºym…ôl…ôri -->

            <div class="d-flex justify-content-start mb-4 gap-3">
                <button
                        class="btn"
                        :class="activeSection === 'configuration' ? 'btn-dark active' : 'btn-outline-dark'"
                        @click="selectSection('configuration')"
                >
                    Configuration
                </button>

                <button
                        class="btn"
                        :class="activeSection === 'analytics' ? 'btn-dark active' : 'btn-outline-dark'"
                        @click="selectSection('analytics')"
                >
                    Analytics
                </button>

            </div>


            <div v-if="activeSection === 'analytics'" class="analytics-container">
                <!-- Loading and Error States -->
                <div v-if="loading" class="loading-overlay">
                    <div class="spinner">Loading...</div>
                </div>

                <div v-if="error" class="error-alert">
                    {{ error }}
                </div>

                <!-- Info Modal -->
                <div v-if="showInfoModal" class="info-modal">
                    {{ infoText }}
                </div>

                <div class="analytics-header">
                    <div class="analytics-title">
                        <h5 class="fw-semibold">General Analytics</h5>
                        <div class="analytics-controls">
                            <button class="btn btn-outline-secondary btn-sm" @click="toggleShowBots">
                                <i class="bi bi-robot"></i>
                                {{ showBots ? 'Hide bots' : 'Show bots' }}
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" @click="exportToCSV">
                                <i class="bi bi-download"></i>
                                CSV
                            </button>
                            <div class="date-range-picker">
                                <div class="date-input-container">
                                    <input type="date" 
                                           ref="startDateInput"
                                           v-model="startDate"
                                           :max="endDate || undefined"
                                           @change="handleDateChange"
                                           class="date-input">
                                    <div class="date-display" @click="openDatePicker('start')">
                                        {{ startDate ? formatFullDate(startDate) : 'DD/MM/YYYY' }}
                                    </div>
                                </div>
                                <span>‚Üí</span>
                                <div class="date-input-container">
                                    <input type="date" 
                                           ref="endDateInput"
                                           v-model="endDate"
                                           :min="startDate || undefined"
                                           @change="handleDateChange"
                                           class="date-input">
                                    <div class="date-display" @click="openDatePicker('end')">
                                        {{ endDate ? formatFullDate(endDate) : 'DD/MM/YYYY' }}
                                    </div>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" @click="resetDateRange">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analytics-content">
                    <!-- Summary Metrics Cards -->
                    <div class="analytics-section">
                        <div class="analytics-card" v-for="metric in summaryMetrics" :key="metric.title">
                            <span class="card-info" @click="showInfo(metric.infoText)">‚ìò</span>
                            <div class="card-header">
                                <i :class="metric.icon"></i>
                                <span class="card-title">{{ metric.title }}</span>
                            </div>
                            <div class="card-value">{{ metric.value }}</div>
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="chart-container">
                        <h6 class="chart-title">Operating Systems Chart</h6>
                        
                        <!-- OS Legend -->
                        <div class="os-legend">
                            <span v-for="os in osLegend" :key="os.name" class="os-legend-item">
                                <span class="os-dot" :style="{ backgroundColor: os.color }"></span>
                                {{ os.name }}
                            </span>
                        </div>
                        
                        <div class="chart-wrapper">
                            <svg width="100%" height="100%" preserveAspectRatio="xMidYMid meet" viewBox="0 0 2000 500">
                                <!-- Chart Grid -->
                                <g class="chart-grid">
                                    <!-- Y-axis line -->
                                    <line 
                                        x1="120" 
                                        y1="50" 
                                        x2="120" 
                                        y2="400"
                                        class="axis-line" 
                                    />

                                    <!-- Horizontal grid lines -->
                                    <template v-for="n in 5" :key="'h'+n">
                                        <line 
                                            x1="120" 
                                            :y1="400 - (n * 87.5)" 
                                            x2="1880" 
                                            :y2="400 - (n * 87.5)"
                                            class="grid-line solid-line"
                                        />
                                        <text 
                                            x="100" 
                                            :y="400 - (n * 87.5)" 
                                            class="grid-label"
                                            text-anchor="end"
                                            alignment-baseline="middle"
                                        >{{ n * 2 }}</text>
                                    </template>

                                    <!-- X-axis line -->
                                    <line 
                                        x1="120" 
                                        y1="400" 
                                        x2="1880" 
                                        y2="400"
                                        class="axis-line" 
                                    />

                                    <!-- Dynamic vertical grid lines and dates -->
                                    <template v-for="(data, index) in filteredChartData" :key="'v'+index">
                                        <line 
                                            :x1="getXPosition(index, filteredChartData.length)"
                                            y1="50"
                                            :x2="getXPosition(index, filteredChartData.length)"
                                            y2="400"
                                            class="grid-line"
                                        />
                                        <text 
                                            :x="getXPosition(index, filteredChartData.length)"
                                            y="420"
                                            class="date-label"
                                            text-anchor="middle"
                                        >{{ formatDynamicDate(data.date) }}</text>
                                    </template>
                                </g>

                                <!-- Data Lines -->
                                <g v-for="os in osLegend" :key="os.name">
                                    <path
                                        :d="getOSPath(os.name)"
                                        :stroke="os.color"
                                        class="data-line"
                                        fill="none"
                                    />
                                </g>

                                <!-- Data Points -->
                                <g v-for="os in osLegend" :key="'points-'+os.name">
                                    <template v-for="(data, index) in filteredChartData" :key="'point-'+index">
                                        <circle
                                            :cx="getXPosition(index, filteredChartData.length)"
                                            :cy="400 - (data.osData[os.name] || 0) * 87.5"
                                            :fill="os.color"
                                            class="data-point"
                                        />
                                    </template>
                                </g>

                                <!-- Hover Overlay -->
                                <rect
                                    class="chart-overlay"
                                    x="120"
                                    y="50"
                                    width="1760"
                                    height="350"
                                    @mousemove="handleChartHover"
                                    @mouseleave="hideTooltip"
                                />
                            </svg>

                            <!-- Tooltip -->
                            <div class="chart-tooltip" v-if="showTooltipData" :style="tooltipStyle">
                                <div class="tooltip-date">{{ tooltipData.date }}</div>
                                <div v-for="(value, os) in tooltipData.values" :key="os" class="tooltip-value-row">
                                    <span class="os-name" :style="{ color: getOSColor(os) }">{{ os }}</span>
                                    <span class="os-value">{{ value }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Data Cards Grid -->
                    <div class="data-grid">
                        <div class="data-card" v-for="card in dataCards" :key="card.title" :data-type="card.type">
                            <div class="card-header">
                                <i :class="card.icon"></i>
                                <span class="card-title">{{ card.title }}</span>
                            </div>
                            <div class="card-content">
                                <template v-if="card.data && card.data.length > 0">
                                    <div class="data-row" 
                                         v-for="(item, index) in card.data" 
                                         :key="index" 
                                         :style="{ '--bar-color': getBarColor(index, card.data.length) }"
                                         @mousemove="$event => { 
                                             const tooltip = $event.currentTarget.querySelector('.data-tooltip');
                                             if (tooltip) {
                                                 tooltip.style.left = ($event.clientX - $event.currentTarget.getBoundingClientRect().left + 10) + 'px';
                                                 tooltip.style.top = ($event.clientY - $event.currentTarget.getBoundingClientRect().top - 40) + 'px';
                                                 tooltip.style.transform = 'none';
                                             }
                                         }">
                                        <div class="data-label">
                                            <span>{{ item.label }}</span>
                                        </div>
                                        <div class="data-value">{{ item.value }}</div>
                                        <div class="data-tooltip">
                                            <div>{{ item.label }}</div>
                                            <div>Value: {{ item.value }}</div>
                                        </div>
                                        <div class="data-bar" :style="{ width: calculatePercentage(item.value, card.data) + '%' }"></div>
                                    </div>
                                </template>
                                <div v-else class="no-data">
                                    No data available
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Date Range -->
<!--                    <div class="date-range" v-if="dateRange">-->
<!--                        <span class="date-range-label">Date Range:</span>-->
<!--                        <span class="date-range-value">{{ dateRange }}</span>-->
<!--                    </div>-->
                </div>
            </div>

            <div v-if="activeSection === 'configuration'">
                <h5 class="fw-semibold">General configuration</h5>

                <div class="row mt-3">
                    <!--                <div class="col-md-2 text-center">-->
                    <!--                    <img src="https://api.qrserver.com/v1/create-qr-code/?data=CTOUT.me/s6l6wd&size=120x120"-->
                    <!--                         class="rounded shadow-sm p-2" alt="QR Code">-->
                    <!--                    <div class="text-muted small mt-2">Click for download</div>-->
                    <!--                </div>-->
                    <div class="col-md-10">
                        <div class="row mb-3">
                            <div class="container py-4">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="form-section-title">Smartlink Name <i
                                                class="bi bi-question-circle"></i>
                                        </div>  
                                        <div class="input-wrapper">
                                            <i class="bi bi-bookmark"></i>
                                            <input type="text" class="readonly-input" value="Draft Smartlink"
                                                   v-model="linkInBio.title">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-section-title">Redirect Url <i
                                                class="bi bi-question-circle"></i>
                                        </div>
                                        <div class="input-wrapper">
                                            <i class="bi bi-bookmark"></i>
                                            <input type="text" class="readonly-input" v-model="linkInBio.originalUrl">
                                        </div>
                                    </div>
                                    <!--                                <div class="col-md-6">-->
                                    <!--                                    <div class="form-section-title">Open Graph Settings</div>-->
                                    <!--                                    <button class="custom-button w-100"><i class="bi bi-window me-2"></i>Open Graph-->
                                    <!--                                    </button>-->
                                    <!--                                </div>-->

                                    <div class="col-md-6">
                                        <div class="form-section-title">Smartlink URL <i
                                                class="bi bi-question-circle"></i>
                                        </div>
                                        <div class="input-wrapper">
                                            <i class="bi bi-link-45deg"></i>
                                            <span class="readonly-input">{{ linkInBio.shortUrl }}</span>
                                            <button class="icon-btn" @click="copyToClipboard(`${linkInBio.shortUrl}`)">
                                                <i class="bi bi-copy"></i></button>
                                            <button class="icon-btn" @click="openSmartlink(`${linkInBio.shortUrl}`)"><i
                                                    class="bi bi-box-arrow-up-right"></i></button>
                                        </div>
                                    </div>
                                    <!--                                <div class="col-md-6">-->
                                    <!--                                    <div class="form-section-title">UTM Settings</div>-->
                                    <!--                                    <button class="custom-button w-100"><i class="bi bi-graph-up-arrow me-2"></i>Generate-->
                                    <!--                                        UTM-->
                                    <!--                                    </button>-->
                                    <!--                                </div>-->

                                    <!--                                <div class="col-md-6">-->
                                    <!--                                    <div class="form-section-title">QR Settings</div>-->
                                    <!--                                    <button class="custom-button w-100" disabled><i class="bi bi-qr-code me-2"></i>Edit-->
                                    <!--                                        QR-->
                                    <!--                                    </button>-->
                                    <!--                                </div>-->
                                    <!--                                <div class="col-md-6">-->
                                    <!--                                    <div class="form-section-title">Script Injector</div>-->
                                    <!--                                    <button class="custom-button w-100" disabled><i class="bi bi-code-slash me-2"></i>Insert-->
                                    <!--                                        Script-->
                                    <!--                                    </button>-->
                                    <!--                                </div>-->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="mt-4">
                            <label class="form-label fw-semibold">Lin in Bio settings</label>
                            <div class="smartlink-type">
                                <button
                                        v-for="tab in tabs"
                                        :key="tab.id"
                                        type="tab-button"
                                        class="btn"
                                        :class="activeTab === tab.id ? 'btn-dark' : 'btn-outline-secondary'"
                                        @click="activeTab = tab.id"
                                >
                                    {{ tab.name }}
                                </button>
                            </div>
                        </div>

                        <!-- App Shortener Tab -->
                        <!--                    <div type="tab" id="app-shortener" :class="{ active: activeTab === 'app-shortener' }" class="mt-4">-->
                        <!--                        <label class="form-label fw-semibold">App download links</label>-->
                        <!--                        <div class="row g-3">-->
                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-label">App Store (iOS) app URL <i class="bi bi-question-circle"></i></label>-->
                        <!--                                <input type="text" class="form-control" v-model="appShortener.ios"-->
                        <!--                                       placeholder="https://apps.apple.com/en/app/your-app-name/id123456789">-->
                        <!--                            </div>-->
                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-label">Google Play (Android) app URL <i-->
                        <!--                                        class="bi bi-question-circle"></i></label>-->
                        <!--                                <input type="text" class="form-control" v-model="appShortener.android"-->
                        <!--                                       placeholder="https://play.google.com/store/apps/details?id=com.example.app">-->
                        <!--                            </div>-->

                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-label">Windows app URL</label>-->
                        <!--                                <input type="text" class="form-control" v-model="appShortener.windows"-->
                        <!--                                       placeholder="https://example.com/windows/9NBLGGH4XXXX">-->
                        <!--                            </div>-->
                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-label">MacOS app URL</label>-->
                        <!--                                <input type="text" class="form-control" v-model="appShortener.macos"-->
                        <!--                                       placeholder="https://apps.apple.com/us/app/your-macos-app/id123456789">-->
                        <!--                            </div>-->

                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-label">iPad version App Store (iOS) app URL</label>-->
                        <!--                                <input type="text" class="form-control" v-model="appShortener.ipad"-->
                        <!--                                       placeholder="https://apps.apple.com/app/ipad-app/id123456789">-->
                        <!--                            </div>-->
                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-label">AppGallery app URL</label>-->
                        <!--                                <input type="text" class="form-control" v-model="appShortener.appGallery"-->
                        <!--                                       placeholder="https://appgallery.huawei.com/app/C123456">-->
                        <!--                            </div>-->

                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-label">Amazon Appstore app URL</label>-->
                        <!--                                <input type="text" class="form-control" v-model="appShortener.amazon"-->
                        <!--                                       placeholder="https://www.amazon.com/gp/product/B00EXAMPLE">-->
                        <!--                            </div>-->
                        <!--                        </div>-->
                        <!--                    </div>-->

                        <!-- URL Shortener Tab -->
                        <!--                    <div type="tab" id="url-shortener" :class="{ active: activeTab === 'url-shortener' }"-->
                        <!--                         class="mt-4 container py-5">-->
                        <!--                        <div class="row g-4 align-items-center">-->
                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-section-title">URL</label>-->
                        <!--                                <input type="text" class="rounded-pill-input" v-model="urlShortener.url"-->
                        <!--                                       placeholder="https://CTOUT.me" readonly>-->
                        <!--                            </div>-->
                        <!--                            <div class="col-md-6">-->
                        <!--                                <label class="form-section-title">Password Protection</label>-->
                        <!--                                <div class="toggle-pill">-->
                        <!--                                    <button-->
                        <!--                                            :class="{ active: !urlShortener.passwordProtected }"-->
                        <!--                                            @click="urlShortener.passwordProtected = false"-->
                        <!--                                    >Off-->
                        <!--                                    </button>-->
                        <!--                                    <button-->
                        <!--                                            :class="{ active: urlShortener.passwordProtected }"-->
                        <!--                                            @click="urlShortener.passwordProtected = true"-->
                        <!--                                    >On-->
                        <!--                                    </button>-->
                        <!--                                </div>-->
                        <!--                            </div>-->
                        <!--                        </div>-->
                        <!--                    </div>-->

                        <!-- Link-in-Bio Tab -->
                        <div type="tab" id="link-in-bio" :class="{ active: activeTab === 'link-in-bio' }">
                            <div class="container">
                                <div class="form-section">
                                    <div class="alert alert-success" v-if="alerts.success.show">
                                        {{ alerts.success.message
                                        }}
                                    </div>
                                    <div class="alert alert-danger" v-if="alerts.error.show">{{ alerts.error.message }}
                                    </div>

                                    <div class="form-group">
                                        <label for="title">Title</label>
                                        <input type="text" id="title" class="form-control" v-model="linkInBio.title">
                                    </div>

                                    <div class="form-group">
                                        <label for="description">Description</label>
                                        <input type="text" id="description" class="form-control"
                                               v-model="linkInBio.description" placeholder="CTOUT">
                                    </div>

                                    <!-- Updated Main Logo Upload Section with X Button -->
                                    <div class="form-group">
                                        <label for="logo">Logo</label>
                                        <div id="logo-upload-section" class="upload-btn" style="position:relative;">
                                            <template v-if="!linkInBio.logoPreview">
                                                <label id="upload-label"
                                                       style="width:100%;display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0;">
                                                    <span class="upload-icon" style="margin-right:8px;">&#8679;</span>
                                                    <span class="upload-text">Upload</span>
                                                    <input type="file" id="logo-input" accept="image/*"
                                                           style="display:none;" @change="handleLogoUpload">
                                                </label>
                                            </template>
                                            <div v-else class="logo-file-row">
                                                <div class="logo-container">
                                                    <img :src="linkInBio.logoPreview" alt="logo"/>

                                                </div>
                                                <span class="file-name">{{ linkInBio.logoFile ? linkInBio.logoFile.name : 'Uploaded logo'}}</span>
                                                <button class="logo-remove-btn logo-remove-btn-main" type="button"
                                                        @click="deleteLogo"
                                                        title="Remove logo">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="theme-color">Theme color</label>
                                        <div class="color-picker">
                                            <input type="color" id="theme-color" class="color-input"
                                                   v-model="linkInBio.themeColor">
                                            <div class="color-swatch"
                                                 :style="{ backgroundColor: linkInBio.themeColor }"></div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Layout</label>
                                        <div class="layout-options">
                                            <button
                                                    v-for="layout in layouts"
                                                    :key="layout.value"
                                                    class="option-btn"
                                                    :class="{ active: linkInBio.layoutType === layout.value }"
                                                    :data-layout="layout.value"
                                                    @click="linkInBio.layoutType = layout.value"
                                            >
                                                {{ layout.name }}
                                            </button>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Theme</label>
                                        <div class="theme-options">
                                            <button
                                                    v-for="theme in themes"
                                                    :key="theme.value"
                                                    class="option-btn"
                                                    :class="{
                                                    'light-theme': theme.value === 'light',
                                                    'dark-theme': theme.value !== 'light',
                                                    'active': linkInBio.themeType === theme.value
                                                }"
                                                    :data-theme="theme.value"
                                                    @click="linkInBio.themeType = theme.value"
                                            >
                                                {{ theme.name }}
                                            </button>
                                        </div>
                                    </div>

                                    <button class="add-link-btn" @click="addLink">
                                        <span>+</span>
                                        Add Link
                                    </button>

                                    <!-- Updated Link Item with X Button on Logo -->
                                    <div class="links-container">
                                        <div class="link-item" v-for="(link, index) in linkInBio.links" :key="index">
                                            <div class="drag-handle">‚ò∞</div>
                                            <div class="link-upload">
                                                <template v-if="!link.logoPreview">
                                                    <span>‚Üë</span>
                                                    <input type="file" accept="image/*" class="link-icon-upload"
                                                           @change="handleLinkLogoUpload($event, index)">
                                                </template>
                                                <div v-else class="link-logo-wrapper">
                                                    <img :src="link.logoPreview" :alt="link.title"
                                                         style="width: 100%; height: 100%; object-fit: cover;">
                                                    <button class="link-logo-delete-btn" @click="deleteLinkLogo(index)"
                                                            title="Remove logo">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                    <input type="file" accept="image/*" class="link-icon-upload"
                                                           @change="handleLinkLogoUpload($event, index)"
                                                           style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
                                                </div>
                                            </div>
                                            <div class="link-inputs">
                                                <input type="text" class="link-input" placeholder="Your link address"
                                                       v-model="link.url">
                                                <input type="text" class="link-input" placeholder="Title"
                                                       v-model="link.title">
                                            </div>
                                            <button class="delete-btn" @click="deleteLink(index)">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <button class="save-btn" @click="saveChanges" :disabled="isSaving">
                                        {{ isSaving ? 'Saving...' : 'Save Changes' }}
                                    </button>
                                </div>

                                <div class="preview-section">
                                    <div class="preview-container">
                                        <div
                                                :class="linkInBio.themeType === 'light' ? 'preview-light' : 'preview-dark'"
                                                id="preview-content"
                                                :style="{ backgroundColor: linkInBio.themeType !== 'light' ? linkInBio.themeColor : '' }"
                                        >
                                            <img v-if="linkInBio.logoPreview" :src="linkInBio.logoPreview"
                                                 class="preview-logo">
                                            <div class="preview-title" id="preview-title">{{ linkInBio.title }}</div>
                                            <div class="preview-description" id="preview-description">
                                                {{ linkInBio.description || 'CTOUT' }}
                                            </div>
                                            <div class="preview-links"
                                                 :class="{ 'grid': linkInBio.layoutType === 'grid' }">
                                                <div class="preview-link" v-for="(link, index) in linkInBio.links"
                                                     :key="'preview-'+index">
                                                    <div class="preview-link-icon">
                                                        <img v-if="link.logoPreview" :src="link.logoPreview"
                                                             :alt="link.title">
                                                    </div>
                                                    <span>{{ link.title }}</span>
                                                </div>
                                            </div>
                                            <div class="preview-footer">Powered by CTOUT</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--                    &lt;!&ndash; QR Tag Tab &ndash;&gt;-->
                        <!--                    <div type="tab" id="qr-tag" :class="{ active: activeTab === 'qr-tag' }">-->
                        <!--                        <div class="container py-5">-->
                        <!--                            <div class="row g-4 mb-4">-->
                        <!--                                <div class="col-md-6">-->
                        <!--                                    <label class="form-section-title">Title</label>-->
                        <!--                                    <input type="text" class="form-control pill-input" v-model="qrTag.title"-->
                        <!--                                           placeholder="Enter title">-->
                        <!--                                </div>-->
                        <!--                                <div class="col-md-6">-->
                        <!--                                    <label class="form-section-title">Description</label>-->
                        <!--                                    <input type="text" class="form-control pill-input" v-model="qrTag.description"-->
                        <!--                                           placeholder="Enter description">-->
                        <!--                                </div>-->

                        <!--                                <div class="col-md-6">-->
                        <!--                                    <label class="form-section-title">Picture</label>-->
                        <!--                                    <input type="file" accept="image/*" class="form-control pill-input"-->
                        <!--                                           @change="handleQRTagImageUpload">-->
                        <!--                                </div>-->
                        <!--                                <div class="col-md-6">-->
                        <!--                                    <label class="form-section-title">Theme color</label>-->
                        <!--                                    <input type="color" class="form-control form-control-color pill-input"-->
                        <!--                                           v-model="qrTag.themeColor">-->
                        <!--                                </div>-->
                        <!--                            </div>-->

                        <!--                            <div class="row g-0">-->
                        <!--                                <div class="col-md-6 bg-light p-4">-->
                        <!--                                    <label class="form-section-title">Select a preset</label>-->
                        <!--                                    <select class="form-select pill-input" v-model="qrTag.preset">-->
                        <!--                                        <option>Select a preset</option>-->
                        <!--                                        <option>Preset 1</option>-->
                        <!--                                        <option>Preset 2</option>-->
                        <!--                                        <option>Preset 3</option>-->
                        <!--                                    </select>-->
                        <!--                                </div>-->
                        <!--                                <div class="col-md-6 bg-light d-flex align-items-center justify-content-center p-4">-->
                        <!--                                    <div class="preview-box">-->
                        <!--                                        <h5>{{ qrTag.title }}</h5>-->
                        <!--                                        <i class="bi bi-link-45deg"></i>-->
                        <!--                                        <div class="text-muted fw-semibold">Add link to preview</div>-->
                        <!--                                        <small class="mt-2 d-block">Powered by <strong>CTOUT</strong></small>-->
                        <!--                                    </div>-->
                        <!--                                </div>-->
                        <!--                            </div>-->
                        <!--                        </div>-->
                        <!--                    </div>-->
                    </div>
                </div>
            </div>
            <!--        </div>-->
        </div>
    </div>

    <!-- Delete confirmation modal -->
    <div class="modal-backdrop" v-if="showDeleteConfirmation" @click.self="showDeleteConfirmation = false">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Smartlink</h5>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this Smartlink? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @click="showDeleteConfirmation = false">Cancel</button>
                <button class="btn-delete" @click="deleteSmartlink" :disabled="isDeleting">
                    <div class="spinner" v-if="isDeleting"></div>
                    {{ isDeleting ? 'Deleting...' : 'Delete' }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    let vm = createApp({
        data() {
            return {
                activeSection: 'analytics',
                shortlinkId: null,
                loading: false,
                error: null,
                infoText: null,
                showInfoModal: false,
                tooltipPosition: {
                    top: '0px',
                    left: '0px' 
                },

                // Summary metrics for the top cards
                summaryMetrics: [
                    {
                        title: 'Total clicks',
                        value: 0,
                        icon: 'bi bi-graph-up',
                        infoText: 'Shows the total number of visits to your links.'
                    },
                    {
                        title: 'Total QR code scans',
                        value: 0,
                        icon: 'bi bi-qr-code',
                        infoText: 'Shows the number of times your QR codes were scanned.'
                    },
                    {
                        title: 'Total Referrals',
                        value: 0,
                        icon: 'bi bi-share',
                        infoText: 'Shows the number of visits from referral links.'
                    }
                ],

                // OS Chart configuration
                osLegend: [
                    { name: 'iOS', color: '#ff6384' },
                    { name: 'macOS', color: '#ffcd56' },
                    { name: 'Windows', color: '#36a2eb' },
                    { name: 'Android', color: '#4bc0c0' },
                    { name: 'Linux', color: '#ff9f40' }
                ],

                // Analytics cards data structure
                dataCards: [
                    {
                        title: 'Devices',
                        icon: 'bi bi-phone',
                        type: 'devices',
                        infoText: 'Shows the distribution of devices used to access your links.',
                        data: []
                    },
                    {
                        title: 'Countries',
                        icon: 'bi bi-globe',
                        type: 'countries',
                        infoText: 'Shows the geographic distribution of your visitors.',
                        data: []
                    },
                    {
                        title: 'OS',
                        icon: 'bi bi-cpu',
                        type: 'os',
                        infoText: 'Shows the distribution of operating systems used by your visitors.',
                        data: []
                    },
                    {
                        title: 'Browsers',
                        icon: 'bi bi-window',
                        type: 'browsers',
                        infoText: 'Shows browser distribution of your visitors.',
                        data: []
                    },
                    {
                        title: 'Languages',
                        icon: 'bi bi-translate',
                        type: 'languages',
                        infoText: 'Shows language preferences of your visitors.',
                        data: []
                    },
                    {
                        title: 'Channels',
                        icon: 'bi bi-diagram-3',
                        type: 'channels',
                        infoText: 'Shows traffic distribution by channel.',
                        data: []
                    },
                    {
                        title: 'Referrers',
                        icon: 'bi bi-box-arrow-in-right',
                        type: 'referrers',
                        infoText: 'Shows where your traffic is coming from.',
                        data: []
                    },
                    {
                        title: 'Redirects',
                        icon: 'bi bi-arrow-return-right',
                        type: 'redirects',
                        infoText: 'Shows information about redirects.',
                        data: []
                    },
                    {
                        title: 'UTM',
                        icon: 'bi bi-tag',
                        type: 'utmParameters',
                        infoText: 'Shows UTM parameter tracking information.',
                        data: []
                    },
                    {
                        title: 'Timezones',
                        icon: 'bi bi-clock',
                        type: 'timezones',
                        infoText: 'Shows visitor distribution by timezone.',
                        data: []
                    },
                    {
                        title: 'Smartlink Type',
                        icon: 'bi bi-link-45deg',
                        type: 'smartlinkTypes',
                        infoText: 'Shows distribution of smartlink types.',
                        data: []
                    },
                    {
                        title: 'Shortened URLs',
                        icon: 'bi bi-link',
                        type: 'shortenedUrls',
                        infoText: 'Shows statistics for shortened URLs.',
                        data: []
                    }
                ],

                // OS Chart data
                osChartData: [],
                dateRange: '',
                tooltipData: {
                    os: '',
                    date: '',
                    value: 0
                },
                tooltipStyle: {
                    left: '0px',
                    top: '0px'
                },
                showTooltipData: false,
                startDate: '',
                endDate: '',
                showBots: true
            };
        },

        created() {
            // Watch for changes in shortlinkId
            this.$watch('shortlinkId', (newId) => {
                if (newId) {
                    this.fetchAnalytics();
                }
            });

            // Check URL for ID
            const urlParams = new URLSearchParams(window.location.search);
            const idFromUrl = urlParams.get('id');
            if (idFromUrl) {
                this.shortlinkId = idFromUrl;
                this.fetchAnalytics();
            }

            // Set initial date range to last 30 days when component is created
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);
            
            this.endDate = end.toISOString().split('T')[0];
            this.startDate = start.toISOString().split('T')[0];
        },
        methods: {
            showInfo(text) {
                this.infoText = text;
                this.showInfoModal = true;
                setTimeout(() => {
                    this.showInfoModal = false;
                }, 3000);
            },

            async fetchAnalytics() {
                if (!this.shortlinkId) {
                    console.error('No shortlinkId available');
                    this.error = "Shortlink ID not found.";
                    return;
                }

                this.loading = true;
                this.error = null;

                try {
                    let url = `/api/short-links/${this.shortlinkId}/analytics`;
                    
                    if (this.startDate && this.endDate) {
                        url += `?startDate=${this.startDate}&endDate=${this.endDate}`;
                    }
                    
                    console.log('Fetching from URL:', url);

                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Analytics fetch error: ${response.status}`);
                    }

                    const analyticsData = await response.json();
                    this.processAnalyticsData(analyticsData);
                } catch (error) {
                    console.error('Error in fetchAnalytics:', error);
                    this.error = `Error occurred: ${error.message}`;
                } finally {
                    this.loading = false;
                }
            },

            processAnalyticsData(data) {
                // Update summary metrics
                this.summaryMetrics[0].value = data.totalClicks || 0;
                this.summaryMetrics[1].value = data.totalQRCodeScans || 0;
                this.summaryMetrics[2].value = data.totalReferrals || 0;

                // Process OS chart data and ensure it's sorted
                if (data.osChartData && data.osChartData.length > 0) {
                    this.osChartData = data.osChartData.sort((a, b) => {
                        return new Date(a.date) - new Date(b.date);
                    });
                }

                // Update other cards with sorting
                this.dataCards[0].data = Object.entries(data.devices || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update countries card with sorting
                this.dataCards[1].data = Object.entries(data.countries || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update OS card with sorting
                this.dataCards[2].data = Object.entries(data.operatingSystems || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update browsers card with sorting
                this.dataCards[3].data = Object.entries(data.browsers || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update languages card with sorting
                this.dataCards[4].data = Object.entries(data.languages || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update channels card with sorting
                this.dataCards[5].data = Object.entries(data.channels || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update referrers card with sorting
                this.dataCards[6].data = Object.entries(data.referrers || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update redirects card with sorting
                this.dataCards[7].data = Object.entries(data.redirects || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update UTM card with sorting
                this.dataCards[8].data = Object.entries(data.utmParameters || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update timezones card with sorting
                this.dataCards[9].data = Object.entries(data.timezones || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update smartlink types card with sorting
                this.dataCards[10].data = Object.entries(data.smartlinkTypes || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Update shortened URLs card with sorting
                this.dataCards[11].data = Object.entries(data.shortenedUrls || {})
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                // Process OS chart data
                if (data.osChartData && data.osChartData.length > 0) {
                    this.osChartData = data.osChartData;

                    // Set date range
                    const dates = data.osChartData.map(item => new Date(item.date));
                    const startDate = new Date(Math.min(...dates));
                    const endDate = new Date(Math.max(...dates));

                    const formatDate = (date) => {
                        const day = date.getDate().toString().padStart(2, '0');
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        return `${day}.${month}`;
                    };

                    this.dateRange = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                }
            },

            calculatePercentage(value, data) {
                const max = Math.max(...data.map(item => item.value));
                return (value / max) * 100;
            },

            formatDateForDisplay(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },

            formatFullDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },

            getDateForIndex(index) {
                if (!this.startDate || !this.endDate) return '';
                
                const start = new Date(this.startDate);
                const end = new Date(this.endDate);
                const totalDays = (end - start) / (1000 * 60 * 60 * 24);
                const daysToAdd = Math.floor((totalDays / 9) * index);
                
                const date = new Date(start);
                date.setDate(date.getDate() + daysToAdd);
                
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },

            getOSPath(osName) {
                if (!this.filteredChartData || !this.filteredChartData.length) return '';

                let path = '';
                const data = this.filteredChartData;
                const totalPoints = data.length;

                // If only one point, draw a dot
                if (totalPoints === 1) {
                    const x = 1000; // Center point
                    const y = 400 - (data[0].osData[osName] || 0) * 87.5;
                    return `M ${x-1} ${y} L ${x+1} ${y}`;
                }

                // Draw line through all points
                data.forEach((point, i) => {
                    const x = this.getXPosition(i, totalPoints);
                    const y = 400 - (point.osData[osName] || 0) * 87.5;
                    
                    if (i === 0) {
                        path += `M ${x} ${y}`;
                    } else {
                        path += ` L ${x} ${y}`;
                    }
                });

                return path;
            },

            getXPosition(index, totalPoints) {
                if (totalPoints <= 1) {
                    return 1000; // Center point for single data
                }
                // Calculate position based on total width and number of points
                const availableWidth = 1760; // Total width minus margins
                const spacing = availableWidth / (totalPoints - 1);
                return 120 + (index * spacing); // Start from x=120 (left margin)
            },

            filteredChartData() {
                if (!this.osChartData || !this.osChartData.length) return [];
                
                // Filter data between start and end dates
                const filteredByDate = this.osChartData.filter(data => {
                    const date = new Date(data.date);
                    const start = this.startDate ? new Date(this.startDate) : null;
                    const end = this.endDate ? new Date(this.endDate) : null;
                    
                    if (start && end) {
                        return date >= start && date <= end;
                    } else if (start) {
                        return date >= start;
                    } else if (end) {
                        return date <= end;
                    }
                    return true;
                }).sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort by date

                if (!filteredByDate.length) return [];
                
                // If only one data point exists, return it
                if (filteredByDate.length === 1) {
                    return filteredByDate;
                }
                
                // If 10 or fewer points, return all
                if (filteredByDate.length <= 10) {
                    return filteredByDate;
                }
                
                // For more than 10 points, select evenly spaced points
                const result = [];
                const step = (filteredByDate.length - 1) / 9;
                
                // Always include first and last points
                result.push(filteredByDate[0]);
                
                // Add 8 evenly spaced points in between
                for (let i = 1; i < 9; i++) {
                    const index = Math.round(i * step);
                    result.push(filteredByDate[index]);
                }
                
                // Add last point
                result.push(filteredByDate[filteredByDate.length - 1]);
                
                return result;
            },

            handleDateChange() {
                if (this.startDate && this.endDate) {
                    const start = new Date(this.startDate);
                    const end = new Date(this.endDate);
                    
                    if (start > end) {
                        this.error = "Start date cannot be after end date";
                        return;
                    }

                    this.fetchAnalytics();
                }
            },

            selectSection(section) {
                this.activeSection = section;
                if (section === 'analytics' && this.shortlinkId) {
                    console.log('Loading analytics for section change, shortlinkId:', this.shortlinkId);
                    this.fetchAnalytics();
                }
            },

            getBarColor(index, total) {
                // Generate colors from light blue to darker blue based on index
                const hue = 210; // Blue hue
                const saturation = 85;
                const lightness = Math.max(65 - (index * (30 / total)), 35); // Gradually decrease lightness
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            },

            getOSColor(osName) {
                const os = this.osLegend.find(o => o.name === osName);
                return os ? os.color : '#ffffff';
            },

            handleChartHover(event) {
                const svgPoint = this.getSVGPoint(event);
                const chartWrapper = event.target.closest('.chart-wrapper');
                const rect = chartWrapper.getBoundingClientRect();

                // Calculate which data point we're closest to
                const xPos = svgPoint.x - 120;
                const step = 1760 / (this.osChartData.length - 1);
                const dataIndex = Math.round(xPos / step);

                if (dataIndex >= 0 && dataIndex < this.osChartData.length) {
                    const data = this.osChartData[dataIndex];

                    this.tooltipData = {
                        date: this.formatDateForDisplay(data.date),
                        values: data.osData
                    };

                    const mouseX = event.clientX - rect.left;
                    const mouseY = event.clientY - rect.top;

                    this.tooltipStyle = {
                        left: `${mouseX}px`,
                        top: `${mouseY - 10}px`,
                        transform: 'translate(-50%, -100%)',
                        opacity: 1,
                        visibility: 'visible'
                    };

                    this.showTooltipData = true;
                }
            },

            hideTooltip() {
                this.showTooltipData = false;
                this.tooltipStyle = {
                    ...this.tooltipStyle,
                    opacity: 0,
                    visibility: 'hidden'
                };
            },

            getSVGPoint(event) {
                const svg = event.target.ownerSVGElement;
                const point = svg.createSVGPoint();
                point.x = event.clientX;
                point.y = event.clientY;
                return point.matrixTransform(svg.getScreenCTM().inverse());
            },

            toggleShowBots() {
                this.showBots = !this.showBots;
                this.fetchAnalytics();
            },

            exportToCSV() {
                const data = this.prepareCSVData();
                const csvContent = "data:text/csv;charset=utf-8," + data;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `analytics_${this.startDate}_${this.endDate}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            prepareCSVData() {
                // Convert analytics data to CSV format
                const headers = ["Date", "iOS", "macOS", "Windows", "Android", "Linux"];
                const rows = [headers];

                this.osChartData.forEach(data => {
                    const row = [
                        this.formatDateForDisplay(data.date),
                        data.osData.iOS || 0,
                        data.osData.macOS || 0,
                        data.osData.Windows || 0,
                        data.osData.Android || 0,
                        data.osData.Linux || 0
                    ];
                    rows.push(row);
                });

                return rows.map(row => row.join(",")).join("\n");
            },

            selectLink(linkId) {
                // Implementation of selectLink method
            },

            createNewLink() {
                // Implementation of createNewLink method
            },

            handleLogoUpload(event) {
                // Implementation of handleLogoUpload method
            },

            deleteLogo() {
                // Implementation of deleteLogo method
            },

            handleLinkLogoUpload(event, index) {
                // Implementation of handleLinkLogoUpload method
            },

            deleteLinkLogo(index) {
                // Implementation of deleteLinkLogo method
            },

            addLink() {
                // Implementation of addLink method
            },

            deleteLink(index) {
                // Implementation of deleteLink method
            },

            saveChanges() {
                // Implementation of saveChanges method
            },

            handleQRTagImageUpload(event) {
                // Implementation of handleQRTagImageUpload method
            },

            resetDateRange() {
                // Set default date range to last 30 days
                const end = new Date();
                const start = new Date();
                start.setDate(start.getDate() - 30);
                
                this.endDate = end.toISOString().split('T')[0];
                this.startDate = start.toISOString().split('T')[0];
                this.fetchAnalytics();
            },

            openDatePicker(type) {
                if (type === 'start') {
                    this.$refs.startDateInput.showPicker();
                } else {
                    this.$refs.endDateInput.showPicker();
                }
            },

            formatDynamicDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },
        },
        setup() {
            const baseUrl = computed(() => {
                // Get the current origin (protocol + hostname + port)
                return window.location.origin;
            });
            // User information
            const loggedInUser = reactive({
                name: 'John',
                surname: 'Doe',
                picture: 'https://via.placeholder.com/32'
            });

            // Sidebar links
            const links = ref([]);
            const selectedLinkId = ref(null);

            // Tabs configuration
            const tabs = [
                // {id: 'app-shortener', name: 'App shortener'},
                // {id: 'url-shortener', name: 'URL shortener'},
                {id: 'link-in-bio', name: 'Link-in-Bio'},
                // {id: 'qr-tag', name: 'QR Tag'}
            ];
            const activeTab = ref('app-shortener');

            // App shortener data
            const appShortener = reactive({
                ios: '',
                android: '',
                windows: '',
                macos: '',
                ipad: '',
                appGallery: '',
                amazon: ''
            });

            // URL shortener data
            const urlShortener = reactive({
                url: 'https://CTOUT.me',
                passwordProtected: false
            });

            // Link-in-Bio data
            const layouts = [
                {name: 'List', value: 'list'},
                {name: 'Grid', value: 'grid'}
            ];

            const themes = [
                {name: 'Light', value: 'light'},
                {name: 'Auto', value: 'auto'},
                {name: 'Dark', value: 'dark'}
            ];

            const linkInBio = reactive({
                title: 'MyTitle',
                description: 'CTOUT',
                logoFile: null,
                logoPreview: null,
                logoUrl: null,
                removeMainLogo: false, // Add this flag
                themeColor: '#101223',
                layoutType: 'list',
                themeType: 'dark',
                shortCode: '',
                shortUrl: '',
                originalUrl: '',
                links: [
                    {title: 'Title', url: '', logoFile: null, logoPreview: null, logoUrl: null, removeLogo: false},
                    {title: 'Title', url: '', logoFile: null, logoPreview: null, logoUrl: null, removeLogo: false},
                    {title: 'Title', url: '', logoFile: null, logoPreview: null, logoUrl: null, removeLogo: false}
                ]
            });

            // QR Tag data
            const qrTag = reactive({
                title: 'CTOUT Smartlink',
                description: 'CTOUT',
                imageFile: null,
                imagePreview: null,
                themeColor: '#000000',
                preset: 'Select a preset'
            });

            // Status flags
            const isSaving = ref(false);
            const alerts = reactive({
                success: {show: false, message: 'Link in bio saved successfully!'},
                error: {show: false, message: ''}
            });

            // Methods
            async function loadLinks() {
                try {
                    const response = await fetch('/api/short-links');
                    links.value = await response.json();
                } catch (error) {
                    console.error('Error loading links:', error);
                }
            }

            async function selectLink(linkId) {
                selectedLinkId.value = linkId;
                activeTab.value = 'link-in-bio';
                vm.shortlinkId = linkId;  // Add this line

                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('tab', 'link-in-bio');
                newUrl.searchParams.set('id', linkId);
                window.history.pushState({}, '', newUrl);

                await loadLinkDetails(linkId);

                if (vm.activeSection === 'analytics') {
                    await vm.fetchAnalytics();
                }
            }

            function addLink() {
                linkInBio.links.push({
                    title: 'New Link',
                    url: '',
                    logoFile: null,
                    logoPreview: null,
                    logoUrl: null
                });
            }

            function deleteLink(index) {
                linkInBio.links.splice(index, 1);
            }

            function handleQRTagImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    qrTag.imageFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        qrTag.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            async function createNewLink() {
                try {
                    // Create empty link in database
                    const formData = new FormData();
                    formData.append('title', 'New Link');
                    formData.append('description', 'CTOUT');
                    formData.append('themeColor', '#000000');
                    formData.append('themeType', 'AUTO');
                    formData.append('layoutType', 'LIST');

                    // Add one empty link
                    formData.append('links[0].title', 'New Link');
                    formData.append('links[0].url', '');

                    // Send to API
                    const response = await fetch('/api/short-links', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create new link');
                    }

                    const newLink = await response.json();

                    // Update URL with the new ID
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('tab', 'link-in-bio');
                    newUrl.searchParams.set('id', newLink.id);
                    window.history.pushState({}, '', newUrl);

                    // Update UI
                    await loadLinks();
                    activeTab.value = 'link-in-bio';
                    selectedLinkId.value = newLink.id;

                    // Load the new link details
                    await loadLinkDetails(newLink.id);
                } catch (error) {
                    console.error('Error creating new link:', error);
                }
            }

            // Check URL parameters on page load
            function checkUrlParameters() {
                const url = new URL(window.location.href);
                const tabParam = url.searchParams.get('tab');
                const idParam = url.searchParams.get('id');

                if (tabParam) {
                    activeTab.value = tabParam;
                }

                if (tabParam === 'link-in-bio' && idParam) {
                    selectedLinkId.value = idParam;
                    loadLinkDetails(idParam);
                }
            }

            function handleLogoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    linkInBio.logoFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        linkInBio.logoPreview = e.target.result;
                    };
                    reader.readAsDataURL(file);

                    // Clear the existing logoUrl and reset remove flag
                    linkInBio.logoUrl = null;
                    linkInBio.removeMainLogo = false;
                }
            }

            function deleteLogo() {
                // Flag that the logo should be removed when saving
                linkInBio.removeMainLogo = true;

                // Clear logo data for UI updates
                linkInBio.logoFile = null;
                linkInBio.logoPreview = null;
                linkInBio.logoUrl = null;
            }

            function handleLinkLogoUpload(event, index) {
                const file = event.target.files[0];
                if (file) {
                    linkInBio.links[index].logoFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        linkInBio.links[index].logoPreview = e.target.result;
                    };
                    reader.readAsDataURL(file);

                    // Clear the existing logoUrl and reset remove flag
                    linkInBio.links[index].logoUrl = null;
                    linkInBio.links[index].removeLogo = false;
                }
            }

            function deleteLinkLogo(index) {
                // Flag this link's logo for removal when saving
                linkInBio.links[index].removeLogo = true;

                // Clear logo data for UI updates
                linkInBio.links[index].logoFile = null;
                linkInBio.links[index].logoPreview = null;
                linkInBio.links[index].logoUrl = null;
            }

            async function loadLinkDetails(linkId) {
                try {
                    const response = await fetch(`/api/short-links/${linkId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch link details');
                    }
                    const linkDetails = await response.json();

                    // Update form fields
                    linkInBio.title = linkDetails.title || '';
                    linkInBio.description = linkDetails.description || '';
                    linkInBio.removeMainLogo = false; // Reset flag when loading
                    linkInBio.shortCode = linkDetails.shortCode || '';
                    linkInBio.shortUrl = (baseUrl.value + '/' + linkDetails.shortCode) || '';
                    linkInBio.originalUrl = linkDetails.originalUrl;
                    // Update theme color
                    if (linkDetails.themeColor) {
                        linkInBio.themeColor = linkDetails.themeColor;
                    } else {
                        // Set default color based on theme type
                        linkInBio.themeColor = linkDetails.themeType === 'LIGHT' ? '#FFFFFF' : '#101223';
                    }

                    // Update layout type and theme type
                    linkInBio.layoutType = linkDetails.layoutType.toLowerCase();
                    linkInBio.themeType = linkDetails.themeType.toLowerCase();

                    // Update main logo
                    if (linkDetails.logoUrl) {
                        linkInBio.logoPreview = linkDetails.logoUrl;
                        linkInBio.logoUrl = linkDetails.logoUrl;
                        linkInBio.logoFile = null;
                    } else {
                        linkInBio.logoPreview = null;
                        linkInBio.logoUrl = null;
                        linkInBio.logoFile = null;
                    }

                    // Update links
                    if (linkDetails.links && linkDetails.links.length > 0) {
                        linkInBio.links = linkDetails.links.map(link => ({
                            title: link.title || '',
                            url: link.url || '',
                            logoFile: null,
                            logoPreview: link.logoUrl || null,
                            logoUrl: link.logoUrl || null,
                            removeLogo: false // Initialize flag for each link
                        }));
                    } else {
                        // Reset to default if no links
                        linkInBio.links = [
                            {
                                title: 'Title',
                                url: '',
                                logoFile: null,
                                logoPreview: null,
                                logoUrl: null,
                                removeLogo: false
                            }
                        ];
                    }
                } catch (error) {
                    console.error('Error loading link details:', error);
                }
            }

            async function saveChanges() {
                try {
                    // Show loading state
                    isSaving.value = true;

                    // Collect form data
                    const formData = new FormData();
                    formData.append('title', linkInBio.title);
                    formData.append('description', linkInBio.description);
                    formData.append('themeColor', linkInBio.themeColor);
                    formData.append('originalUrl', linkInBio.originalUrl);

                    // Handle main logo
                    if (linkInBio.logoFile) {
                        // New file uploaded
                        formData.append('logoFile', linkInBio.logoFile);
                    } else if (linkInBio.logoUrl && !linkInBio.removeMainLogo) {
                        // Existing logo kept
                        formData.append('logoUrl', linkInBio.logoUrl);
                    } else if (linkInBio.removeMainLogo) {
                        // Logo removed
                        formData.append('removeMainLogo', 'true');
                    }

                    // Add theme and layout
                    formData.append('themeType', linkInBio.themeType.toUpperCase());
                    formData.append('layoutType', linkInBio.layoutType.toUpperCase());

                    // Collect links
                    linkInBio.links.forEach((link, index) => {
                        if (link.url && link.title) {
                            formData.append(`links[${index}].title`, link.title);
                            formData.append(`links[${index}].url`, link.url);

                            // Handle link logo
                            if (link.logoFile) {
                                // New logo file uploaded
                                formData.append(`links[${index}].logoFile`, link.logoFile);
                            } else if (link.logoUrl && !link.removeLogo) {
                                // Existing logo kept
                                formData.append(`links[${index}].logoUrl`, link.logoUrl);
                            } else if (link.removeLogo) {
                                // Logo was removed
                                formData.append(`links[${index}].removeLogo`, 'true');
                            }
                        }
                    });

                    // Determine if this is an update or create
                    const method = selectedLinkId.value ? 'PUT' : 'POST';
                    const url = selectedLinkId.value ? `/api/short-links/${selectedLinkId.value}` : '/api/short-links';

                    // Send to API
                    const response = await fetch(url, {
                        method: method,
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.message || 'Failed to save link in bio');
                    }

                    // Reset remove flags after successful save
                    linkInBio.removeMainLogo = false;
                    linkInBio.links.forEach(link => {
                        link.removeLogo = false;
                    });

                    // Show success message
                    alerts.success.show = true;
                    alerts.error.show = false;
                    setTimeout(() => {
                        alerts.success.show = false;
                    }, 3000);

                    // If this was a new creation, update the URL with the new ID
                    if (!selectedLinkId.value) {
                        const responseData = await response.json();
                        if (responseData.id) {
                            selectedLinkId.value = responseData.id;
                            const newUrl = new URL(window.location.href);
                            newUrl.searchParams.set('id', responseData.id);
                            window.history.pushState({}, '', newUrl);
                        }
                    }

                    // Reload the links list in the sidebar
                    await loadLinks();

                } catch (error) {
                    // Show error message
                    alerts.error.show = true;
                    alerts.error.message = error.message;
                    alerts.success.show = false;
                } finally {
                    // Reset button state
                    isSaving.value = false;
                }
            }

            // Delete functionality
            const showDeleteConfirmation = ref(false);
            const isDeleting = ref(false);

            async function deleteSmartlink() {
                if (!selectedLinkId.value) return;

                try {
                    isDeleting.value = true;

                    // Call the delete endpoint
                    const response = await fetch(`/api/short-links/${selectedLinkId.value}`, {
                        method: 'DELETE',
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete Smartlink');
                    }

                    // Close the confirmation modal
                    showDeleteConfirmation.value = false;

                    // Show success message
                    alerts.success.show = true;
                    alerts.success.message = 'Smartlink deleted successfully!';
                    setTimeout(() => {
                        alerts.success.show = false;
                    }, 3000);

                    // Reset selected link and reload the sidebar links
                    selectedLinkId.value = null;

                    // Update URL parameters
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.delete('id');
                    window.history.pushState({}, '', newUrl);

                    // Reload links in the sidebar
                    await loadLinks();

                    // Reset the active tab to the first tab
                    activeTab.value = tabs[0].id;

                } catch (error) {
                    console.error('Error deleting Smartlink:', error);

                    // Show error message
                    alerts.error.show = true;
                    alerts.error.message = error.message || 'Failed to delete Smartlink';
                    setTimeout(() => {
                        alerts.error.show = false;
                    }, 5000);
                } finally {
                    isDeleting.value = false;
                }
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        alerts.success.show = true;
                        alerts.success.message = 'URL copied to clipboard!';
                        setTimeout(() => {
                            alerts.success.show = false;
                        }, 3000);
                    })
                    .catch(err => {
                        console.error('Failed to copy URL: ', err);
                    });
            }

            function openSmartlink(url) {
                window.open(`${url}`, '_blank');
            }

            // Lifecycle hooks
            onMounted(() => {
                loadLinks();
                checkUrlParameters();
            });

            return {
                loggedInUser,
                links,
                selectedLinkId,
                tabs,
                activeTab,
                appShortener,
                urlShortener,
                linkInBio,
                qrTag,
                layouts,
                themes,
                alerts,
                isSaving,
                showDeleteConfirmation,
                isDeleting,

                // Methods
                baseUrl,
                copyToClipboard,
                openSmartlink,
                deleteSmartlink,
                selectLink,
                handleLogoUpload,
                deleteLogo,
                handleLinkLogoUpload,
                deleteLinkLogo,
                addLink,
                deleteLink,
                createNewLink,
                saveChanges,
                handleQRTagImageUpload,
            };
        }
    }).mount('#app');
</script>
</body>
</html>