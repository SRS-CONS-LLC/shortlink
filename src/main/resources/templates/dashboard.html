<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>CITOUT Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="/public/css/dashboard.css"/>
</head>
<body>
<div id="app" class="d-flex layout">
    <!-- Sidebar -->
    <template th:replace="sidebar.html"></template>

    <!-- Main Content -->
    <div class="main-content">
        <div v-if="selectedLinkId" class="config-card">
            <div class="position-relative">
                <h4 class="fw-bold mb-3" ><i class="bi bi-link-45deg"></i> <span v-text="linkInBio.title"></span></h4>
                <!-- Delete button (only show if a Link is selected) -->
                <button
                        v-if="selectedLinkId"
                        class="delete-link-btn"
                        @click="showDeleteConfirmation = true"
                        :disabled="isDeleting">
                    <i class="bi bi-trash"></i>
                    Delete Link
                </button>
            </div>
            <div class="d-flex justify-content-start mb-4 gap-3">
                <button class="btn btn-dark active">Configuration</button>
            </div>

            <h5 class="fw-semibold">General configuration</h5>
            <div class="row mt-3">

                <div class="col-md-10">
                    <div class="row mb-3">
                        <div class="container py-4">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="form-section-title">Link Name <i class="bi bi-question-circle"></i>
                                    </div>
                                    <div class="input-wrapper">
                                        <i class="bi bi-bookmark"></i>
                                        <input type="text" class="readonly-input" v-model="linkInBio.title">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-section-title">Redirect Url <i class="bi bi-question-circle"></i>
                                    </div>
                                    <div class="input-wrapper">
                                        <i class="bi bi-bookmark"></i>
                                        <input type="text" class="readonly-input" v-model="linkInBio.originalUrl">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-section-title">Link Type <i class="bi bi-question-circle"></i>
                                    </div>
                                    <div class="input-wrapper">
                                        <select class="form-control" v-model="linkInBio.linkType">
                                            <option value="REDIRECT">Redirect</option>
                                            <option value="BIO">Bio</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-section-title">Link URL <i class="bi bi-question-circle"></i>
                                    </div>
                                    <div class="input-wrapper">
                                        <i class="bi bi-link-45deg"></i>
                                        <span class="readonly-input">{{ linkInBio.shortUrl }}</span>
                                        <button class="icon-btn" @click="copyToClipboard(`${linkInBio.shortUrl}`)"><i class="bi bi-copy"></i></button>
                                        <button class="icon-btn" @click="openLink(`${linkInBio.shortUrl}`)"><i class="bi bi-box-arrow-up-right"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="mt-4">
                        <label class="form-label fw-semibold">Lin in Bio settings</label>
                        <div class="link-type">
                            <button
                                    v-for="tab in tabs"
                                    :key="tab.id"
                                    type="tab-button"
                                    class="btn"
                                    :class="activeTab === tab.id ? 'btn-dark' : 'btn-outline-secondary'"
                                    @click="activeTab = tab.id"
                            >
                                {{ tab.name }}
                            </button>
                        </div>
                    </div>

                    <!-- Link-in-Bio Tab -->
                    <div type="tab" id="link-in-bio" :class="{ active: activeTab === 'link-in-bio' }">
                        <div class="container">
                            <div class="form-section">
                                <div class="alert alert-success" v-if="alerts.success.show">{{ alerts.success.message
                                    }}
                                </div>
                                <div class="alert alert-danger" v-if="alerts.error.show">{{ alerts.error.message }}
                                </div>

                                <div class="form-group">
                                    <label for="title">Title</label>
                                    <input type="text" id="title" class="form-control" v-model="linkInBio.title">
                                </div>

                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <input type="text" id="description" class="form-control"
                                           v-model="linkInBio.description" placeholder="CITOUT">
                                </div>

                                <!-- Updated Main Logo Upload Section with X Button -->
                                <div class="form-group">
                                    <label for="logo">Logo</label>
                                    <div id="logo-upload-section" class="upload-btn" style="position:relative;">
                                        <template v-if="!linkInBio.logoPreview">
                                            <label id="upload-label"
                                                   style="width:100%;display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0;">
                                                <span class="upload-icon" style="margin-right:8px;">&#8679;</span>
                                                <span class="upload-text">Upload</span>
                                                <input type="file" id="logo-input" accept="image/*"
                                                       style="display:none;" @change="handleLogoUpload">
                                            </label>
                                        </template>
                                        <div v-else class="logo-file-row">
                                            <div class="logo-container">
                                                <img :src="linkInBio.logoPreview" alt="logo"/>

                                            </div>
                                            <span class="file-name">{{ linkInBio.logoFile ? linkInBio.logoFile.name : 'Uploaded logo'}}</span>
                                            <button class="logo-remove-btn logo-remove-btn-main" type="button" @click="deleteLogo"
                                                    title="Remove logo">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="theme-color">Theme color</label>
                                    <div class="color-picker">
                                        <input type="color" id="theme-color" class="color-input"
                                               v-model="linkInBio.themeColor">
                                        <div class="color-swatch"
                                             :style="{ backgroundColor: linkInBio.themeColor }"></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Layout</label>
                                    <div class="layout-options">
                                        <button
                                                v-for="layout in layouts"
                                                :key="layout.value"
                                                class="option-btn"
                                                :class="{ active: linkInBio.layoutType === layout.value }"
                                                :data-layout="layout.value"
                                                @click="linkInBio.layoutType = layout.value"
                                        >
                                            {{ layout.name }}
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Theme</label>
                                    <div class="theme-options">
                                        <button
                                                v-for="theme in themes"
                                                :key="theme.value"
                                                class="option-btn"
                                                :class="{
                                                    'light-theme': theme.value === 'light',
                                                    'dark-theme': theme.value !== 'light',
                                                    'active': linkInBio.themeType === theme.value
                                                }"
                                                :data-theme="theme.value"
                                                @click="linkInBio.themeType = theme.value"
                                        >
                                            {{ theme.name }}
                                        </button>
                                    </div>
                                </div>

                                <button class="add-link-btn" @click="addLink">
                                    <span>+</span>
                                    Add Link
                                </button>

                                <!-- Updated Link Item with X Button on Logo -->
                                <div class="links-container">
                                    <div class="link-item" v-for="(link, index) in linkInBio.links" :key="index">
                                        <template v-if="!link.deleted">
                                            <div class="drag-handle">☰</div>
                                            <div class="link-upload">
                                                <template v-if="!link.logoPreview">
                                                    <span>↑</span>
                                                    <input type="file" accept="image/*" class="link-icon-upload"
                                                           @change="handleLinkLogoUpload($event, index)">
                                                </template>
                                                <div v-else class="link-logo-wrapper">
                                                    <img :src="link.logoPreview" :alt="link.title"
                                                         style="width: 100%; height: 100%; object-fit: cover;">
                                                    <button class="link-logo-delete-btn" @click="deleteLinkLogo(index)" title="Remove logo">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                    <input type="file" accept="image/*" class="link-icon-upload"
                                                           @change="handleLinkLogoUpload($event, index)"
                                                           style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
                                                </div>
                                            </div>
                                            <div class="link-inputs">
                                                <input type="text"
                                                       class="form-control link-input"
                                                       placeholder="Your link address"
                                                       v-model="link.url"
                                                       @input="validateUrl(link)"
                                                       :class="{ 'is-invalid': !link.isValidUrl, 'is-valid': link.isValidUrl}"
                                                       required>
                                                <div v-if="!link.isValidUrl" class="invalid-feedback">
                                                    Please enter a valid URL
                                                </div>
                                                <input type="text" class="link-input" placeholder="Title"
                                                       v-model="link.title">
                                            </div>
                                            <button class="delete-btn" @click="softDeleteLink(index)">🗑️</button>
                                        </template>
                                        <template v-else>
                                            <div class="text-muted fst-italic d-flex align-items-center justify-content-between px-2 py-1 bg-light rounded">
                                                <span>This link removed. It will be deleted after save.</span>
                                                <button class="btn btn-sm btn-outline-secondary ms-2" @click="undoDelete(index)">Undo</button>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <button class="save-btn" @click="saveChanges" :disabled="isSaving">
                                    {{ isSaving ? 'Saving...' : 'Save Changes' }}
                                </button>
                            </div>

                            <div class="preview-section">
                                <div class="preview-container">
                                    <div
                                            :class="linkInBio.themeType === 'light' ? 'preview-light' : 'preview-dark'"
                                            id="preview-content"
                                            :style="{ backgroundColor: linkInBio.themeType !== 'light' ? linkInBio.themeColor : '' }"
                                    >
                                        <img v-if="linkInBio.logoPreview" :src="linkInBio.logoPreview"
                                             class="preview-logo">
                                        <div class="preview-title" id="preview-title">{{ linkInBio.title }}</div>
                                        <div class="preview-description" id="preview-description">
                                            {{ linkInBio.description || 'CITOUT' }}
                                        </div>
                                        <div class="preview-links" :class="{ 'grid': linkInBio.layoutType === 'grid' }">
                                            <div class="preview-link" v-for="(link, index) in linkInBio.links"
                                                 :key="'preview-'+index">
                                                <div class="preview-link-icon" v-if="link.logoPreview">
                                                    <img  :src="link.logoPreview"
                                                         :alt="link.title">
                                                </div>
                                                <span>{{ link.title }}</span>
                                            </div>
                                        </div>
                                        <div class="preview-footer">Powered by CITOUT</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div v-if="links.length===0" class="bg-light d-flex align-items-center justify-content-center">
            <div class="row justify-content-center">
                <div class="card border-0">
                    <div class="card-body text-center p-5">
                        <h1 class="display-5 fw-bold mb-4">Create Your First Link</h1>
                        <p class="text-muted mb-4">Get started by creating your first hyperlink</p>
                        <a href="#" class="btn btn-primary btn-lg px-4 py-2" @click.prevent="createNewLink">Create Link</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete confirmation modal -->
    <div class="modal-backdrop" v-if="showDeleteConfirmation" @click.self="showDeleteConfirmation = false">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Link</h5>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this Link? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @click="showDeleteConfirmation = false">Cancel</button>
                <button class="btn-delete" @click="deleteLink" :disabled="isDeleting">
                    <div class="spinner" v-if="isDeleting"></div>
                    {{ isDeleting ? 'Deleting...' : 'Delete' }}
                </button>
            </div>
        </div>
    </div>
</div>

<script src="/public/js/index.js"></script>
</body>
</html>